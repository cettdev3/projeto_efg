{% extends "index.html" %} {% block content %}
{% load static %}

<style>
  #myInput {
  background-image: url('/css/searchicon.png'); /* Add a search icon to input */
  background-position: 10px 12px; /* Position the search icon */
  background-repeat: no-repeat; /* Do not repeat the icon image */
  width: 100%; /* Full-width */
  font-size: 16px; /* Increase font-size */
  padding: 12px 20px 12px 40px; /* Add some padding */
  border: 1px solid #ddd; /* Add a grey border */
  margin-bottom: 12px; /* Add some space below the input */
}

#myTable {
  border-collapse: collapse; /* Collapse borders */
  width: 100%; /* Full-width */
  border: 1px solid #ddd; /* Add a grey border */

}

#myTable th, #myTable td {
  text-align: left; /* Left-align text */
  padding: 12px; /* Add padding */
}

#myTable tr {
  /* Add a bottom border to all table rows */
  border-bottom: 1px solid #ddd;
}

#myTable tr.header, #myTable tr:hover {
  /* Add a grey background color to the table header and on hover */
  background-color: #f1f1f1;
}
</style>
<div class="page-heading">
  <h3>Cadastrar Metas Analíticas - EFG</h3>
</div>
<div class="card">
  <div class="card-header">
    <h4 class="card-title">Inserir metas de ensino do convênio</h4>
  </div>

  <div class="card-body">
    <div class="column">
      
      <div>
        <form
          name="Form"
          id="Form"
          class="form-control"
          method="post"
          action="/editarmetas"
        >
          {% csrf_token %}
         
          {% if messages %}

            {% for message in messages %}
              <div class="alert alert-dismissible alert-success" role="alert">
                  <strong class="text-dark">{{message}}</strong>
              </div>
            {% endfor %}
          {% endif %}

          <div class="row">
          <div class="col-md-4 form-group">
            <label for="basicInput"><b>DIRETORIA:</b></label>
            <select class="form-control" id="diretoria" name="diretoria">
              <option {% if meta_edit.diretoria == 'DAC' %} selected {% endif %} value="DAC">DAC</option>
              <option {% if meta_edit.diretoria == 'DDE' %} selected {% endif %} value="DDE">DDE</option>
              <option {% if meta_edit.diretoria == 'DE' %} selected {% endif %} value="DE">DE</option>
            </select>
          </div>

          <input style="display: none ;" name="id" id="id" value="{{meta_edit.id}}">
        
         

          <div class="col-md-4 form-group">
            <label for="basicInput"><b>ESCOLA:</b></label>
            <select class="form-control" id="escola" name="escola">
              {% for escola in escolas %}
              <option {% if meta_edit.escola_id == escola.id %} selected {% endif %} value="{{escola.id}}">{{escola.escola}}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-4 form-group">
            <label for="basicInput"><b>TIPO DE CURSO:</b></label>
            <select class="form-control" id="tipo" name="tipo">
             {% for tipo in tipos_cursos %}
              <option {% if meta_edit.tipo_curso_id == tipo.id %} selected {% endif %} value="{{tipo.id}}">{{tipo.tipo}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 form-group">
            <label for="basicInput"><b>EIXOS:</b></label>
            <select class="form-control" id="eixo" name="eixo">
              {% for eixo in eixos %}
              
              <option {% if meta_edit.eixo_id == eixo.id %} selected {% endif %} value="{{eixo.id}}">{{eixo.nome}}</option>
              {% endfor %}       
            </select>
          </div>

          <div class="col-md-4 form-group">
            <label for="basicInput"><b>MODALIDADE:</b></label>
            
            <select class="form-control" id="modalidade" name="modalidade">
              {% for modalidade in modalidades %}
              <option  {% if meta_edit.modalidade_id == modalidade.id %} selected {% endif %} value="{{modalidade.id}}">{{modalidade.modalidade}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4 form-group">
       
            <label for="basicInput"><b>CURSOS:</b></label>
            <select class="form-control" id="curso" name="curso">
              {% for curso in cursos %}
              <option {% if meta_edit.curso_id|floatformat == curso.id|floatformat  %} selected {% endif %}   value="{{curso.id}}">{{curso.curso}} </option>
              {% endfor %}       
            </select>
          </div>

          <div class="col-md-4 form-group">
            <label for="basicInput"><b>TURNO:</b></label>
            <select class="form-control" id="turno" name="turno">
              <option {% if meta_edit.turno == 'VESPERTINO' %} selected {% endif %} value="VESPERTINO">VESPERTINO</option>
              <option {% if meta_edit.turno == 'MATUTINO' %} selected {% endif %} value="MATUTINO">MATUTINO</option>
              <option {% if meta_edit.turno == 'NOTURNO' %} selected {% endif %} value="NOTURNO">NOTURNO</option>
            </select>
          </div>

          <div class="col-md-4 form-group">
            <label for="basicInput"><b>ANO:</b></label>
            <input
              type="number"
              class="form-control"
              id="ano"
              name="ano"
              placeholder="Informe o ano:"
              max="2999" maxlength="4" min="2022"
              value="{{meta_edit.ano}}"
            >
          </div>

            

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>TRIMESTRE:</b></label>
              <input
                type="number"
                class="form-control"
                id="trimestre"
                name="trimestre"
                placeholder="Informe o trimestre:"
                max="9" maxlength="1" min="1"
                value="{{meta_edit.trimestre}}"
              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>CARGA HORÁRIA:</b></label>
              <input
                type="number"
                class="form-control"
                id="carga_horaria"
                name="carga_horaria"
                placeholder="Informe a quantidade de vagas:"
                min="1"
                
                value="{{meta_edit.carga_horaria}}"
                oninput="calcular()"
              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>VAGAS TOTAIS:</b></label>
              <input
                type="number"
                class="form-control"
                id="vagas_totais"
                name="vagas_totais"
                placeholder="Informe a quantidade de vagas:"
                min="1"
                value="{{meta_edit.vagas_totais}}"
                oninput="calcular()"
              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>VAGAS POR TURMA:</b></label>
              <input
                type="number"
                class="form-control"
                id="vagas_turma"
                name="vagas_turma"
                placeholder="Informe a quantidade de vagas por turma:"
                min="1"
                value="{{meta_edit.vagas_turma}}"
              >
            </div>

            <div class="col-md-4 form-group"  id="cht_ajax">
              <label for="basicInput"><b>CARGA HORÁRIA TOTAL:</b></label>
              <input
                type="number"
                class="form-control"
                id="ch_total"
                name="ch_total"
                placeholder="Informe a carga horária:"
                min="1"
                value="{{meta_edit.carga_horaria_total}}"
                readonly
              >
              <input style="display: none;" id="ch_antiga" name="ch_antiga" value="{{meta_edit.carga_horaria_total}}" >
              <input style="display: none;" id="limite" name="limite" value="{{limite}}" >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>DATA PREVISTA PARA INÍCIO:</b></label>
              <input
                type="text"
                class="form-control"
                id="data_p_inicio"
                name="data_p_inicio"
                value="{{meta_edit.previsao_inicio|date:'d/m/Y'}}"
                onkeypress="mascaraData( this, event )"
                maxlength="10"

              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>DATA PREVISTA PARA FINALIZAR:</b></label>
              <input
                type="text"
                class="form-control"
                id="data_p_fim"
                name="data_p_fim"
                value="{{meta_edit.previsao_fim|date:'d/m/Y'}}"
                onkeypress="mascaraData( this, event )"
                maxlength="10"
              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>DIAS DA SEMANA:</b></label>
              <input
                type="text"
                class="form-control"
                id="dias_semana"
                name="dias_semana"
                value="{{meta_edit.dias_semana}}"
              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>PREVISÃO PARA ABERTURA DO EDITAL:</b></label>
              <input
                type="text"
                class="form-control"
                id="p_abertura_edital"
                name="p_abertura_edital"
                value="{{meta_edit.previsao_abertura_edital|date:'d/m/Y'}}"
                onkeypress="mascaraData( this, event )"
                maxlength="10"
              >
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput"><b>PREVISÃO PARA FECHAMENTO DO EDITAL:</b></label>
              <input
                type="text"
                class="form-control"
                id="p_fechamento_edital"
                name="p_fechamento_edital"
                value="{{meta_edit.previsao_fechamento_edital|date:'d/m/Y'}}"
                onkeypress="mascaraData( this, event )"
                maxlength="10"
              >
            </div>





            
          </div>
          
          <div class="form-group" style="width: 100%; text-align: right;">
            <a href="/cadastrar-metas" class="btn btn-secondary">Voltar</a>
            <button  onclick="validaForm()" type="button" class="btn btn-success">Atualizar Metas</button>
        </div>
        </form>
      </div>
    </div>
  </div>
  </div>

  <div class="modal fade text-left" id="ops" tabindex="-1" role="dialog"
      aria-labelledby="myModalLabel140" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"
          role="document">
        
          <div class="modal-content">
              <div class="modal bg-danger center">
                  <h5  class="modal-title white" >Limite Excedido!
                  </h5>
      
              </div>
           
              <div class="modal-body" style="text-align: center;">
                <h2 style="color: #000000;"><b>Oops!</b></h2>
                 <b>Não foi possível adicionar a carga horária total!
                  <br>O valor excede o limite permitido ou o saldo de horas não está cadastrado.</b>
                  <br><br><h3 style="color: #000000;" id="total_de_horas_disponiveis"></h3><hr>
                  Horas cadastradas para este tipo de lançamento
                </div>
              <div class="modal-footer">
                <button style="width: 100%;" type="button" class="btn btn-light-secondary"
                data-bs-dismiss="modal">
                <i class="bx bx-x d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Fechar</span>
            </button>
              </div>
          </div>
        
      </div>
      </div>
  



<script>
  function insereTexto(id)
    {document.getElementById('id_deleta').value = id;}
</script>

<script>
  
  function validaForm() {
    var limite = parseInt($("#limite").val());
    var cht = parseInt($("#ch_total").val());
    document.getElementById('total_de_horas_disponiveis').innerHTML = limite
    if (cht > limite || cht == 0){
      if (cht == 0){
        document.getElementById('total_de_horas_disponiveis').innerHTML = "Sem Registros"
        document.getElementById('total_de_horas_disponiveis').style.color = "red"
        $('#ops').modal('show');
      }else{
        document.getElementById('total_de_horas_disponiveis').innerHTML = "Carga Horária Total Excedida!"
        document.getElementById('total_de_horas_disponiveis').style.color = "red"
        $('#ops').modal('show');
      }
      
      
    }else{
      trimestre = $("#trimestre").val()
      vagas_turma = $("#vagas_turma").val()
      data_p_inicio = $("#data_p_inicio").val()
      data_p_fim = $("#data_p_fim").val()
      dias_semana = $("#dias_semana").val()
      p_abertura_edital = $("#p_abertura_edital").val()
      p_fechamento_edital = $("#p_fechamento_edital").val()

      if (trimestre == "" || vagas_turma == "" || data_p_inicio == "" || data_p_fim == "" || dias_semana == "" || p_abertura_edital == "" || p_fechamento_edital == "" ){

        if(trimestre == ""){
          document.getElementById('trimestre').style.borderColor = "red"
        }else{
          document.getElementById('trimestre').style.borderColor = ""
        }

        if(vagas_turma == ""){
          document.getElementById('vagas_turma').style.borderColor = "red"
        }else{
          document.getElementById('vagas_turma').style.borderColor = ""
        }

        if(data_p_inicio == ""){
          document.getElementById('data_p_inicio').style.borderColor = "red"
        }else{
          document.getElementById('data_p_inicio').style.borderColor = ""
        }

        if(data_p_fim == ""){
          document.getElementById('data_p_fim').style.borderColor = "red"
        }else{
          document.getElementById('data_p_fim').style.borderColor = ""
        }

        if(p_abertura_edital == ""){
          document.getElementById('p_abertura_edital').style.borderColor = "red"
        }else{
          document.getElementById('p_abertura_edital').style.borderColor = ""
        }

        if(dias_semana == ""){
          document.getElementById('dias_semana').style.borderColor = "red"
        }else{
          document.getElementById('dias_semana').style.borderColor = ""
        }

        if(p_fechamento_edital == ""){
          document.getElementById('p_fechamento_edital').style.borderColor = "red"
        }else{
          document.getElementById('p_fechamento_edital').style.borderColor = ""
        }
      
      }else{
        document.getElementById('Form').submit();
      }
      
    }

  }
  
  function calcular() {
    var n1 = parseInt(document.getElementById("carga_horaria").value, 10);
    var n2 = parseInt(document.getElementById("vagas_totais").value, 10);
    var resultado = n1 * n2;
    document.getElementById("ch_total").value = parseInt(resultado);
  }


  $("#escola").change(function(){
       
        const url = "/ajax/ajax_load_cht";
        const url_eixos = '/ajax/ajax_load_eixos';
        const url_cursos = "/ajax/ajax_load_cursos";

        escola = $(this).val();
        tipo_curso = document.getElementById('tipo').value
        ano = document.getElementById('ano').value
        modalidade = document.getElementById('modalidade').value
        eixo = document.getElementById('eixo').value
        $.ajax({
          url : url_cursos,
          data: {'escola_id': escola,'tipo_id':tipo_curso,'eixo_id':eixo,'modalidade_id':modalidade},
          success: function(data){
              $("#curso").html(data);
    
          }
      });

        $.ajax({
            url : url_eixos,
            data: {'escola_id': escola,'tipo_id':tipo_curso},
            success: function(data){
                $("#eixo").html(data);
            }
        });

        $.ajax({
            url : url,
            data: {'escola_id': escola,'tipo_id':tipo_curso,'ano':ano,'modalidade_id':modalidade},
            success: function(data){
                $("#cht_ajax").html(data);
                calcular()
            }
        });
    });

  $("#tipo").change(function(){
       
       const url = "/ajax/ajax_load_cht";
       const url_cursos = "/ajax/ajax_load_cursos";

       tipo_curso = $(this).val();
       escola = document.getElementById('escola').value
       ano = document.getElementById('ano').value
       modalidade = document.getElementById('modalidade').value
       eixo = document.getElementById('eixo').value
       $.ajax({
          url : url_cursos,
          data: {'escola_id': escola,'tipo_id':tipo_curso,'eixo_id':eixo,'modalidade_id':modalidade},
          success: function(data){
              $("#curso").html(data);
    
          }
      });

       $.ajax({
           url : url,
           data: {'escola_id': escola,'tipo_id':tipo_curso,'ano':ano,'modalidade_id':modalidade},
           success: function(data){
               $("#cht_ajax").html(data);
               calcular()
           }
       });
   });

  $("#ano").change(function(){
       
       const url = "/ajax/ajax_load_cht";
       ano = $(this).val();
       escola = document.getElementById('escola').value
       tipo_curso = document.getElementById('tipo').value
       modalidade = document.getElementById('modalidade').value
       $.ajax({
           url : url,
           data: {'escola_id': escola,'tipo_id':tipo_curso,'ano':ano,'modalidade_id':modalidade},
           success: function(data){
               $("#cht_ajax").html(data);
               calcular()
           }
       });
   });

  $("#modalidade").change(function(){
       
      const url = "/ajax/ajax_load_cht";
      const url_cursos = "/ajax/ajax_load_cursos";
  
      modalidade = $(this).val();
      eixo = document.getElementById('eixo').value
      escola = document.getElementById('escola').value
      console.log(escola)
      tipo_curso = document.getElementById('tipo').value
      ano = document.getElementById('ano').value
      
      console.log(eixo)
      $.ajax({
          url : url_cursos,
          data: {'escola_id': escola,'tipo_id':tipo_curso,'eixo_id':eixo,'modalidade_id':modalidade},
          success: function(data){
              $("#curso").html(data);
    
          }
      });

      $.ajax({
          url : url,
          data: {'escola_id': escola,'tipo_id':tipo_curso,'ano':ano,'modalidade_id':modalidade},
          success: function(data){
              $("#cht_ajax").html(data);
              calcular()
          }
      });
  });

  $("#eixo").change(function(){
        const url_cursos = "/ajax/ajax_load_cursos";

        eixo = $(this).val();
        tipo_curso = document.getElementById('tipo').value
        modalidade = document.getElementById('modalidade').value
        escola = document.getElementById('escola').value
        tipo_curso = document.getElementById('tipo').value

        $.ajax({
          url : url_cursos,
          data: {'escola_id': escola,'tipo_id':tipo_curso,'eixo_id':eixo,'modalidade_id':modalidade},
          success: function(data){
              $("#curso").html(data);
    
          }
      });

    });

  function insereTexto(id,vagas_totais,carga_horaria,escola,tipo,ano)
    {
      console.log(id)
      document.getElementById('id_deleta').value = id;
      var total = vagas_totais * carga_horaria
      document.getElementById('cht').value = total
      document.getElementById('escola_delete').value = escola
      document.getElementById('tipo_delete').value = tipo
      document.getElementById('ano_delete').value = ano
      }

  function mascaraData( campo, e )
  {
    var kC = (document.all) ? event.keyCode : e.keyCode;
    var data = campo.value;
    
    if( kC!=8 && kC!=46 )
    {
      if( data.length==2 )
      {
        campo.value = data += '/';
      }
      else if( data.length==5 )
      {
        campo.value = data += '/';
      }
      else
        campo.value = data;
    }
  }
</script>

  {% endblock content %}

