{% extends "index.html" %} {% block content %} {% load static %}
<style>
  #myInput {
  background-repeat: no-repeat; /* Do not repeat the icon image */
  width: 100%; /* Full-width */
  font-size: 16px; /* Increase font-size */
  padding: 12px 20px 12px 40px; /* Add some padding */
  border: 1px solid #ddd; /* Add a grey border */
  margin-bottom: 12px; /* Add some space below the input */
}



#myTable {
  border-collapse: collapse; /* Collapse borders */
  width:100%; /* Full-width */
  border: 1px solid #ddd; /* Add a grey border */

}

#myTable th, #myTable td {
  text-align: center; /* Left-align text */
  padding: 10px; /* Add padding */
  overflow-wrap: break-word;
}

#myTable tr {
  /* Add a bottom border to all table rows */
  border-bottom: 1px solid #ddd;
}

#myTable tr.header, #myTable tr:hover {
  /* Add a grey background color to the table header and on hover */
  background-color: #00f36d6c;
}

@media screen and (max-width: 1280px) {
    .myTable {
        border: 0px;
    }
    .myTable caption {
        font-size: 22px;
    }
    .myTable thead {
        display: none;
    }
    .TamyTableble tr {
        margin-bottom: 8px;
        border-bottom: 4px solid #ddd;
        display: block;
        
    }
    .myTable th, .table td {
        font-size: 12px;
        
    }
    .myTable td {
        display: block;
        border-bottom: 1px solid #ddd;
        
        
    }
    .myTable  td:last-child {
        border-bottom: 0px;
    }
    .myTable td::before {
        content: attr(data-label);
        font-weight: bold;
        text-transform: uppercase;
        float: left;
    }
    .myTable button, btn_voltar{
      width: 100%;
      margin-bottom: 10px;
    }
}
    </style>
<div class="page-heading">
  <h3>Orçamento de Plano de Trabalho</h3>
</div>
<div class="card">
  <div class="card-header">
    <h4 class="card-title">Lançamento de Orçamento</h4>
  </div>

  <div class="card-body">
    <div class="column">
      <div>
        <form
          name="Form"
          id="Form"
          class="form-control"
          method="post"
          action="/cad-orcamento-plano-trabalho"
          data-funcoes-url="{% url 'ajax_load_funcoes_orcamento' %}"
        >
          {% csrf_token %}
          {% if messages %}
          {% for message in messages %}
          <div class="alert alert-dismissible alert-success" role="alert">
            <strong class="text-dark">{{message}}</strong>
          </div>
          {% endfor %} 
          {% endif %}

          <div class="row">
            <div class="col-md-6 form-group">
              <label for="basicInput">TIPO:</label>
              <select class="form-control" id="tipo" name="tipo">
                <option value="Receita">Receita</option>
                <option value="Despesa">Despesa</option>
              </select>
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Rubrica:</label>
              <select class="form-control" id="rubrica" name="rubrica">
                <option selected>Selecione a Rubrica</option>
                {% for rubrica in rubricas %}
                <option value="{{rubrica.id}}">{{rubrica.rubrica}}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-md-6 form-group">
              <label for="basicInput">Item Apoiado:</label>
              <select class="form-control" id="item_apoiado" name="item_apoiado">
                <option selected>Selecione um Item Apoiado</option>
                {% for item_ap in itens_apoiados %}
                <option value="{{item_ap.id}}">{{item_ap.item_apiado}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Und:</label>
              <select class="form-control" id="unidade" name="unidade">
                <option selected>Selecione uma unidade</option>
                {% for unidade in unidades %}
                <option value="{{unidade.und}}">{{unidade.und}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Qtd Global:</label>
              <input
                type="number"
                class="form-control"
                id="qtd_global"
                name="qtd_global"
                step = "0.01"
                
              />
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Valor Médio Unitário:</label>
              <input
                type="number"
                class="form-control"
                id="v_m_unitario"
                name="v_m_unitario"
                step="0.01"
                
              />
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput">Valor Global:</label>
              <input
                type="number"
                class="form-control"
                id="valor_global"
                name="valor_global"
                step="0.01"
                
                
              />
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput">Custeio:</label>
              <input
                type="number"
                class="form-control"
                id="custeio"
                name="custeio"
                step="0.01"
                
                
              />
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput">Capital:</label>
              <input
                type="number"
                class="form-control"
                id="capital"
                name="capital"
                step="0.01"
                
                
              />
            </div>


            
          </div>

          <div class="form-group" style="width: 100%; text-align: right">
            <a href="/" id="btn_voltar" class="btn btn-secondary">Voltar</a>
            <button type="submit" class="btn btn-success">Inserir Orçamento</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<section class="section">
  <div class="card">
    <div class="card-header">
      <h4 class="card-title">Metas Adicionadas</h4>
      <input
        type="text"
        id="myInput"
        onkeyup="myFunction()"
        placeholder="Procurar Escola..."
      />

      
    </div>

    <div class="card-body">
      <table id="myTable" class="myTable">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Rubrica</th>
            <th>Item Apoiado</th>
            <th>Und</th>
            <th>Qtd Global</th>
            <th>Valor Global</th>
            <th>Custeio</th>
            <th>Capital</th>
            <th>Ação</th>

          </tr>
        </thead>
        <tbody>
          {% for planejamento in planejamentos %}
                    <tr>
                      <td id="tipo_id{{planejamento.id}}">{{planejamento.tipo}}</td>
                      <td><span id="rubrica_id{{planejamento.id}}" style="display: none;">{{planejamento.rubrica.id}}</span>{{planejamento.rubrica.rubrica}}</td>
                      <td><span id="item_apoiado{{planejamento.id}}" style="display: none;">{{planejamento.item_apoiado.id}}</span>{{planejamento.item_apoiado.item_apoiado}}</td>
                      <td id="und{{planejamento.id}}">{{planejamento.und}}</td>
                      <td id="qtd{{planejamento.id}}">{{planejamento.qtd_global}}</td>
                      <span style="display: none;" id="valor_medio{{planejamento.id}}">{{planejamento.valor_medio_unitario}}</span>
                      <td id="valor{{planejamento.id}}">{{planejamento.valor_global}}</td>
                      <td id="custeio{{planejamento.id}}">{{planejamento.custeio}}</td>
                      <td id="capital{{planejamento.id}}">{{planejamento.capital}}</td>
                      
                      <td>
                        <button type="button" onclick='atualiza("{{planejamento.id}}")' class="btn icon btn-primary" data-bs-toggle="modal" data-bs-target="#xlarge">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button
                          type="button"
                          onclick='insereTexto("{{planejamento.id}}")'
                          class="btn icon btn-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#warning"
                        >
                          <i class="bi bi-x"></i>
                        </button>
                        <!---<a  class="deleteFromMeta btn icon btn-danger" href="apagar-meta/{{meta.id}}"><i class="bi bi-x"></i></a></td>-->
                      </td>
                    </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<div
  class="modal fade text-left"
  id="warning"
  tabindex="-1"
  role="dialog"
  aria-labelledby="myModalLabel140"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-centered modal-dialog-scrollable"
    role="document"
  >
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title white" id="myModalLabel140">
          Confirma a exclusão do orçamento?
        </h5>
        <button
          type="button"
          class="close"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <i data-feather="x"></i>
        </button>
      </div>

      <div class="modal-body">Ao confirmar, o orçamento será excluído.</div>
      <div class="modal-footer">
        <form
          name="Form"
          id="Form"
          method="POST"
          action="/apagar-orcamento"
          data-funcoes-url="{% url 'ajax_load_funcoes_orcamento' %}"
        >
          {% csrf_token %}
          <div style="display: none" >
            <input type="text" id="id_deleta" name="id_deleta" />
          </div>
          <button
            type="button"
            class="btn btn-light-secondary"
            data-bs-dismiss="modal"
          >
            <i class="bx bx-x d-block d-sm-none"></i>
            <span class="d-none d-sm-block">Fechar</span>
          </button>
          <button class="btn btn-danger ml-1" type="submit">
            Confirmar Exclusão
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade text-left w-100"
  id="xlarge"
  tabindex="-1"
  role="dialog"
  aria-labelledby="myModalLabel16"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl"
    role="document"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel16">Editar Dados</h4>
        <button
          type="button"
          class="close"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <i data-feather="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <form
          name="Form2"
          id="Form2"
          class="form-control"
          method="post"
          action="/edit-orcamento-plano-trabalho"
          data-funcoes-url="{% url 'ajax_load_funcoes_orcamento' %}"
        >
        
          {% csrf_token %}
          <input id="id_edit" name="id_edit" style="display: none;">
          {% if messages %}
          {% for message in messages %}
          <div class="alert alert-dismissible alert-success" role="alert">
            <strong class="text-dark">{{message}}</strong>
          </div>
          {% endfor %} 
          {% endif %}

          <div class="row">
            <div class="col-md-6 form-group">
              <label for="basicInput">TIPO:</label>
              <select class="form-control" id="tipo2" name="tipo2">
                <option value="Receita">Receita</option>
                <option value="Despesa">Despesa</option>
              </select>
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Rubrica:</label>
              <select class="form-control" id="rubrica2" name="rubrica2">
                <option selected>Selecione a Rubrica</option>
                {% for rubrica in rubricas %}
                <option value="{{rubrica.id}}">{{rubrica.rubrica}}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-md-6 form-group">
              <label for="basicInput">Item Apoiado:</label>
              <select class="form-control" id="item_apoiado2" name="item_apoiado2">
                <option selected>Selecione um Item Apoiado</option>
                {% for item_ap in itens_apoiados %}
                <option  value="{{item_ap.id}}">{{item_ap.item_apiado}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Und:</label>
              <select class="form-control" id="unidade2" name="unidade2">
                <option selected>Selecione uma unidade</option>
                {% for unidade in unidades %}
                <option value="{{unidade.und}}">{{unidade.und}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Qtd Global:</label>
              <input
                type="number"
                class="form-control"
                id="qtd_global2"
                name="qtd_global2"
                step = "0.01"
                
              />
            </div>

            <div class="col-md-6 form-group">
              <label for="basicInput">Valor Médio Unitário:</label>
              <input
                type="number"
                class="form-control"
                id="v_m_unitario2"
                name="v_m_unitario2"
                step="0.01"
                
              />
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput">Valor Global:</label>
              <input
                type="number"
                class="form-control"
                id="valor_global2"
                name="valor_global2"
                step="0.01"
                
                
              />
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput">Custeio:</label>
              <input
                type="number"
                class="form-control"
                id="custeio2"
                name="custeio2"
                step="0.01"
                
                
              />
            </div>

            <div class="col-md-4 form-group">
              <label for="basicInput">Capital:</label>
              <input
                type="number"
                class="form-control"
                id="capital2"
                name="capital2"
                step="0.01"
                
                
              />
            </div>


            
          </div>

          <div class="form-group" style="width: 100%; text-align: right">
            <a href="/" id="btn_voltar" class="btn btn-secondary">Voltar</a>
            <button type="submit" class="btn btn-success">Atualizar Orçamento</button>
          </div>
        </form>
      </div>
    
    </div>
  </div>
</div>
{% block javascript %}

<script type="text/javascript">
  $("#rubrica").change(function(){
      const url = $('#Form').attr("data-funcoes-url");
      setorId = $(this).val();
      $.ajax({
          url : url,
          data: {'id_rubrica': setorId},
          success: function(data){
              $("#item_apoiado").html(data);
          }
      });
  });

  $("#rubrica2").change(function(){
      const url = $('#Form2').attr("data-funcoes-url");
      setorId = $(this).val();
      $.ajax({
          url : url,
          data: {'id_rubrica': setorId},
          success: function(data){
              $("#item_apoiado2").html(data);
          }
      });
  });
</script>

<script>


  function insereTexto(id) {
    document.getElementById("id_deleta").value = id;
  }

  function atualiza(id) {
    let tipo = document.getElementById("tipo_id"+id).innerHTML
    let rubrica = document.getElementById("rubrica_id"+id).innerHTML
    let item_apoiado = document.getElementById("item_apoiado"+id).innerHTML
    let und = document.getElementById("und"+id).innerHTML
    let qtd = document.getElementById("qtd"+id).innerHTML
    let valor = document.getElementById("valor"+id).innerHTML
    let valor_medio = document.getElementById("valor_medio"+id).innerHTML
    let valor_global = document.getElementById("valor"+id).innerHTML
    let custeio = document.getElementById("custeio"+id).innerHTML
    let capital = document.getElementById("capital"+id).innerHTML
    

    document.getElementById("id_edit").value = id;
    $('#tipo2').val(tipo.trim()).change();
    $('#rubrica2').val(rubrica.trim()).change();
    $('#unidade2').val(und.trim()).change();
    document.getElementById("qtd_global2").value = qtd;
    document.getElementById("v_m_unitario2").value = valor_medio;
    document.getElementById("qtd_global2").value = qtd;
    document.getElementById("valor_global2").value = valor;
    document.getElementById("custeio2").value = custeio;
    document.getElementById("capital2").value = capital;

    id_rubrica_selected = document.getElementById("rubrica2").value
    const url = $('#Form').attr("data-funcoes-url");
      setorId = id_rubrica_selected

      $.ajax({
          url : url,
          data: {'id_rubrica': setorId},
          success: function(data){
            console.log(data)
              $("#item_apoiado2").html(data);
              $('#item_apoiado2').val(item_apoiado.trim()).change();
          }
      });

      

    //atualiza_select(rubrica)
    // $('#escola2').val(escola.trim()).change();
    // $('#modalidade2').val(modalidade.trim()).change();
    // document.getElementById("descricao2").value = descricao;
    // document.getElementById("ano2").value = ano;
    // $('#tipo2').val(categoria.trim()).change();
    // document.getElementById("ch_ofertada2").value = ch_ofertada;
    // document.getElementById("vagas2").value = vagas;
    // document.getElementById("repasse2").value = repasse;
    // document.getElementById("valor_unitario2").value = valor_unitario;


    
  }
</script>


<script>
  function myFunction() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("myInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("myTable");
    tr = table.getElementsByTagName("tr");
  
    // Loop through all table rows, and hide those who don't match the search query
    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByTagName("td")[2];
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }
</script>
<script>
 
  function calcular() {
    var n1 = parseInt(document.getElementById("repasse").value, 10);
    var n2 = parseInt(document.getElementById("ch_ofertada").value, 10);
    var resultado = n1 / n2;
    document.getElementById("valor_unitario").value = resultado.toFixed(2);
  }
</script>

<script>
  function calcular2() {
    var n1 = parseInt(document.getElementById("repasse2").value, 10);
    var n2 = parseInt(document.getElementById("ch_ofertada2").value, 10);
    var resultado = n1 / n2;
    document.getElementById("valor_unitario2").value = resultado.toFixed(2);
  }
</script>

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
 <script src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap4.min.js"></script>
{% endblock %}

{% endblock content %}
